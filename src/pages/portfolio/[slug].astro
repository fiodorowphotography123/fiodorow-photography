---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { getPortfolioItems, urlFor, categoryLabels } from "../../lib/sanity";

// Fetch from Sanity for static path generation
export async function getStaticPaths() {
  // Fallback static data
  const fallbackData: Record<string, any> = {
    "joanna-darek": {
      title: "Joanna & Darek",
      date: "8 czerwca 2024",
      description:
        "To był słoneczny, czerwcowy dzień pełen radości i dobrej energii. Asia i Darek powiedzieli sobie TAK wśród najbliższych i serdecznych znajomych.",
      category: "reportaz-slubny",
      location: "Siedlce",
      images: [
        "https://images.unsplash.com/photo-1519741497674-611481863552?w=1400&q=90",
        "https://images.unsplash.com/photo-1606800052052-a08af7148866?w=1400&q=90",
        "https://images.unsplash.com/photo-1594463750939-ebb28c3f7f75?w=1400&q=90",
      ],
    },
    "natalia-michal": {
      title: "Natalia & Michał",
      date: "15 maja 2024",
      description:
        "Romantyczna sesja narzeczeńska w historycznych zaułkach Białegostoku.",
      category: "sesja-narzeczenska",
      location: "Białystok",
      images: [
        "https://images.unsplash.com/photo-1522673607200-164d1b6ce486?w=1400&q=90",
        "https://images.unsplash.com/photo-1529634806980-85c3dd6d34ac?w=1400&q=90",
      ],
    },
    "amelia-damian": {
      title: "Amelia & Damian",
      date: "22 lipca 2024",
      description: "Piękny letni ślub w sercu Warszawy.",
      category: "reportaz-slubny",
      location: "Warszawa",
      images: [
        "https://images.unsplash.com/photo-1606216794074-735e91aa2c92?w=1400&q=90",
        "https://images.unsplash.com/photo-1594463750939-ebb28c3f7f75?w=1400&q=90",
      ],
    },
  };

  // Try to fetch from Sanity
  let sanityItems: any[] = [];
  try {
    sanityItems = await getPortfolioItems();
  } catch (e) {
    console.log("Sanity fetch failed in getStaticPaths, using fallback");
  }

  // Build paths from Sanity data
  const sanityPaths = sanityItems.map((item) => ({
    params: { slug: item.slug.current },
    props: {
      portfolio: {
        title: item.title,
        date: item.date
          ? new Date(item.date).toLocaleDateString("pl-PL", {
              day: "numeric",
              month: "long",
              year: "numeric",
            })
          : "",
        description: item.description || "",
        category: item.category || "reportaz-slubny",
        location: item.location || "",
        // Use higher quality images (1400px width, 90% quality)
        coverImage: item.coverImage
          ? urlFor(item.coverImage).width(1400).quality(90).url()
          : null,
        images: item.images
          ? item.images.map((img: any) =>
              urlFor(img).width(1400).quality(90).url(),
            )
          : [],
      },
    },
  }));

  // Build paths from fallback data
  const fallbackPaths = Object.entries(fallbackData).map(([slug, data]) => ({
    params: { slug },
    props: { portfolio: data },
  }));

  // Merge: Sanity paths first, then fallback paths that don't exist in Sanity
  const existingSlugs = new Set(sanityPaths.map((p) => p.params.slug));
  const uniqueFallbackPaths = fallbackPaths.filter(
    (p) => !existingSlugs.has(p.params.slug),
  );

  return [...sanityPaths, ...uniqueFallbackPaths];
}

const { portfolio } = Astro.props;

if (!portfolio) {
  return Astro.redirect("/portfolio");
}
---

<BaseLayout
  title={`${portfolio.title} | Fiodorow Photography`}
  description={portfolio.description}
>
  <Header currentPath="/portfolio" />

  <!-- Portfolio Detail -->
  <section class="pt-32 pb-20 md:pt-40 md:pb-32 bg-cream">
    <div class="max-w-6xl mx-auto px-6 md:px-12">
      <!-- Header Section -->
      <div class="text-center mb-16 md:mb-20">
        <span
          class="inline-block text-[0.65rem] tracking-[0.25em] uppercase text-charcoal-light mb-4 px-4 py-2 border border-charcoal/20"
        >
          {portfolio.category}
        </span>
        <h1
          class="font-serif text-4xl md:text-5xl lg:text-6xl tracking-[0.1em] uppercase text-charcoal mt-4 mb-6"
        >
          {portfolio.title}
        </h1>
        <p class="font-serif text-lg text-olive italic mb-8">
          {portfolio.date}
        </p>
        <!-- Description -->
        <div class="max-w-3xl mx-auto mb-16 px-4">
          <p
            class="text-center text-charcoal-light text-base md:text-lg leading-relaxed font-light whitespace-pre-line"
          >
            {portfolio.description}
          </p>
        </div>

        <!-- Image Grid - Masonry Style (CSS Columns) -->
        <div class="columns-1 md:columns-2 lg:columns-3 gap-4 space-y-4">
          {
            portfolio.images.map((image: string, index: number) => (
              <div
                class="break-inside-avoid overflow-hidden cursor-pointer gallery-item relative group"
                data-index={index}
                style={`animation-delay: ${index * 50}ms`}
              >
                <img
                  src={image}
                  alt={`${portfolio.title} - zdjęcie ${index + 1}`}
                  class="w-full h-auto object-cover transition-transform duration-700 group-hover:scale-105"
                  loading={index < 5 ? "eager" : "lazy"}
                />
                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors duration-300" />
              </div>
            ))
          }
        </div>

        <!-- Location badge -->
        <div class="mt-16 text-center">
          <span
            class="inline-flex items-center gap-2 text-sm text-charcoal-light px-6 py-3 border border-charcoal/10 bg-white"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            {portfolio.location}
          </span>
        </div>

        <!-- Navigation -->
        <div
          class="mt-16 pt-8 border-t border-charcoal/10 flex flex-col sm:flex-row justify-between items-center gap-4"
        >
          <a href="/portfolio" class="btn-primary"> ← Powrót do Portfolio </a>
          <a href="/kontakt" class="btn-primary"> Zarezerwuj termin </a>
        </div>
      </div>
    </div>

    <!-- Lightbox -->
    <div
      id="lightbox"
      class="fixed inset-0 bg-black/95 z-50 hidden items-center justify-center"
    >
      <button
        id="lightbox-close"
        class="absolute top-6 right-6 text-white/70 hover:text-white transition-colors"
        aria-label="Zamknij"
      >
        <svg
          class="w-8 h-8"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>

      <button
        id="lightbox-prev"
        class="absolute left-6 text-white/70 hover:text-white transition-colors"
        aria-label="Poprzednie"
      >
        <svg
          class="w-8 h-8"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>

      <button
        id="lightbox-next"
        class="absolute right-6 text-white/70 hover:text-white transition-colors"
        aria-label="Następne"
      >
        <svg
          class="w-8 h-8"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M9 5l7 7-7 7"></path>
        </svg>
      </button>

      <img
        id="lightbox-img"
        src=""
        alt=""
        class="max-w-[90vw] max-h-[90vh] object-contain"
      />
    </div>

    <Footer />
  </section>

  <script define:vars={{ images: portfolio.images }}>
    const galleryItems = document.querySelectorAll(".gallery-item");
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightbox-img");
    const closeBtn = document.getElementById("lightbox-close");
    const prevBtn = document.getElementById("lightbox-prev");
    const nextBtn = document.getElementById("lightbox-next");

    let currentIndex = 0;

    function openLightbox(index) {
      currentIndex = index;
      lightboxImg.src = images[index];
      lightbox.classList.remove("hidden");
      lightbox.classList.add("flex");
      document.body.style.overflow = "hidden";
    }

    function closeLightbox() {
      lightbox.classList.add("hidden");
      lightbox.classList.remove("flex");
      document.body.style.overflow = "";
    }

    function showPrev() {
      currentIndex = (currentIndex - 1 + images.length) % images.length;
      lightboxImg.src = images[currentIndex];
    }

    function showNext() {
      currentIndex = (currentIndex + 1) % images.length;
      lightboxImg.src = images[currentIndex];
    }

    galleryItems.forEach((item) => {
      item.addEventListener("click", () => {
        const index = parseInt(item.getAttribute("data-index") || "0");
        openLightbox(index);
      });
    });

    closeBtn?.addEventListener("click", closeLightbox);
    prevBtn?.addEventListener("click", showPrev);
    nextBtn?.addEventListener("click", showNext);

    lightbox?.addEventListener("click", (e) => {
      if (e.target === lightbox) closeLightbox();
    });

    document.addEventListener("keydown", (e) => {
      if (!lightbox?.classList.contains("hidden")) {
        if (e.key === "Escape") closeLightbox();
        if (e.key === "ArrowLeft") showPrev();
        if (e.key === "ArrowRight") showNext();
      }
    });
  </script>
</BaseLayout>
