---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getPortfolioItems, urlFor, categoryLabels } from '../../lib/sanity';

// Fetch from Sanity
let sanityItems: any[] = [];
try {
  sanityItems = await getPortfolioItems();
} catch (e) {
  console.log('Sanity fetch failed, using fallback data');
}

// Fallback static data (used when Sanity is empty)
const fallbackItems = [
  {
    image: "https://images.unsplash.com/photo-1594463750939-ebb28c3f7f75?w=800&q=80",
    category: "reportaz-slubny",
    title: "Joanna & Darek",
    slug: { current: "joanna-darek" },
    date: "2024-06-08"
  },
  {
    image: "https://images.unsplash.com/photo-1522673607200-164d1b6ce486?w=800&q=80",
    category: "sesja-narzeczenska",
    title: "Natalia & Michał",
    slug: { current: "natalia-michal" },
    date: "2024-05-15"
  },
  {
    image: "https://images.unsplash.com/photo-1606216794074-735e91aa2c92?w=800&q=80",
    category: "reportaz-slubny",
    title: "Amelia & Damian",
    slug: { current: "amelia-damian" },
    date: "2024-07-22"
  },
  {
    image: "https://images.unsplash.com/photo-1519741497674-611481863552?w=800&q=80",
    category: "reportaz-slubny",
    title: "Karolina & Piotr",
    slug: { current: "karolina-piotr" },
    date: "2024-08-10"
  },
  {
    image: "https://images.unsplash.com/photo-1591604466107-ec97de577aff?w=800&q=80",
    category: "sesja-portretowa",
    title: "Anna",
    slug: { current: "anna-portret" },
    date: "2024-04-05"
  },
  {
    image: "https://images.unsplash.com/photo-1529634806980-85c3dd6d34ac?w=800&q=80",
    category: "sesja-rodzinna",
    title: "Rodzina Nowaków",
    slug: { current: "rodzina-nowakow" },
    date: "2024-03-18"
  }
];

// Use Sanity data if available, otherwise fallback
const portfolioItems = sanityItems.length > 0 ? sanityItems.map(item => ({
  image: item.coverImage ? urlFor(item.coverImage).width(1200).quality(90).url() : fallbackItems[0].image,
  category: item.category,
  title: item.title,
  slug: item.slug,
  date: item.date
})) : fallbackItems;

const categories = ["Wszystkie", "Reportaż ślubny", "Sesja narzeczeńska", "Sesja portretowa", "Sesja rodzinna"];
---

<BaseLayout 
  title="Portfolio | Fiodorow Photography" 
  description="Portfolio fotograficzne - reportaże ślubne, sesje narzeczeńskie, portrety. Fotograf Siedlce, Białystok, Warszawa."
>
  <Header currentPath="/portfolio" />
  
  <!-- Portfolio Section -->
  <section class="pt-32 pb-20 md:pt-40 md:pb-32 bg-cream">
    <div class="max-w-7xl mx-auto px-6 md:px-12">
      
      <!-- Title -->
      <div class="text-center mb-16">
        <h1 class="font-serif text-3xl md:text-4xl tracking-[0.2em] uppercase text-charcoal mb-4">
          Portfolio
        </h1>
        <p class="text-charcoal-light text-sm md:text-base max-w-md mx-auto">
          Odkryj nasze prace. Każda sesja to wyjątkowa historia opowiedziana przez obiektyw.
        </p>
      </div>
      
      <!-- Category Filter -->
      <div class="flex flex-wrap justify-center gap-3 md:gap-4 mb-16" id="category-filter">
        {categories.map((cat, index) => (
          <button 
            class:list={[
              "category-btn px-4 py-2 text-[0.65rem] md:text-xs tracking-[0.15em] uppercase transition-all duration-300 border",
              index === 0 ? "active bg-charcoal text-white border-charcoal" : "bg-transparent border-charcoal/20 text-charcoal hover:border-charcoal hover:bg-charcoal/5"
            ]}
            data-category={cat === "Wszystkie" ? "all" : cat}
          >
            {cat}
          </button>
        ))}
      </div>
      
      <!-- Symmetric 3-Column Portfolio Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8" id="portfolio-grid">
        {portfolioItems.map((item, index) => (
          <a 
            href={`/portfolio/${item.slug.current}`} 
            class="portfolio-card group relative overflow-hidden block"
            data-category={categoryLabels[item.category] || item.category}
            style={`animation-delay: ${index * 80}ms`}
          >
            <!-- Image -->
            <div class="relative aspect-[3/4] overflow-hidden">
              <img 
                src={item.image}
                alt={item.title}
                class="w-full h-full object-cover transition-transform duration-700 ease-out group-hover:scale-110"
                loading={index < 3 ? "eager" : "lazy"}
              />
              
              <!-- Hover Overlay -->
              <div class="absolute inset-0 bg-gradient-to-t from-charcoal/80 via-charcoal/30 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
              
              <!-- Hover Content -->
              <div class="absolute inset-0 flex flex-col justify-end p-5 md:p-6 translate-y-4 group-hover:translate-y-0 opacity-0 group-hover:opacity-100 transition-all duration-500">
                <span class="text-[0.6rem] md:text-[0.65rem] tracking-[0.25em] uppercase text-white/80 mb-1">
                  {categoryLabels[item.category] || item.category}
                </span>
                <h3 class="font-serif text-lg md:text-xl tracking-[0.1em] uppercase text-white">
                  {item.title}
                </h3>
              </div>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>
  
  <!-- CTA Section -->
  <section class="py-20 md:py-24 bg-white">
    <div class="max-w-3xl mx-auto px-6 text-center">
      <h2 class="section-title mb-6">Chcesz zobaczyć więcej?</h2>
      <p class="text-charcoal-light text-sm md:text-base leading-relaxed mb-10 max-w-xl mx-auto">
        Każda sesja to dla nas nowe wyzwanie. Skontaktuj się z nami, aby omówić Twój projekt.
      </p>
      <a href="/kontakt" class="btn-primary">
        Skontaktuj się
      </a>
    </div>
  </section>
  
  <Footer />
</BaseLayout>

<style>
  .portfolio-grid {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 1rem;
  }
  
  @media (min-width: 768px) {
    .portfolio-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 1.25rem;
    }
  }
  
  @media (min-width: 1024px) {
    .portfolio-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
    }
  }
  
  .portfolio-card {
    animation: fadeInUp 0.8s ease-out forwards;
    opacity: 0;
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  const filterBtns = document.querySelectorAll('.category-btn');
  const portfolioItems = document.querySelectorAll('#portfolio-grid > a');
  
  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      // Update active state
      filterBtns.forEach(b => {
        b.classList.remove('active', 'bg-charcoal', 'text-white', 'border-charcoal');
        b.classList.add('bg-transparent', 'border-charcoal/20', 'text-charcoal');
      });
      btn.classList.add('active', 'bg-charcoal', 'text-white', 'border-charcoal');
      btn.classList.remove('bg-transparent', 'border-charcoal/20');
      
      const category = btn.getAttribute('data-category');
      
      portfolioItems.forEach(item => {
        const itemCategory = item.getAttribute('data-category');
        
        if (category === 'all' || itemCategory === category) {
          (item as HTMLElement).style.display = 'block';
          setTimeout(() => {
            (item as HTMLElement).style.opacity = '1';
            (item as HTMLElement).style.transform = 'translateY(0)';
          }, 50);
        } else {
          (item as HTMLElement).style.opacity = '0';
          (item as HTMLElement).style.transform = 'translateY(20px)';
          setTimeout(() => {
            (item as HTMLElement).style.display = 'none';
          }, 300);
        }
      });
    });
  });
</script>
